from Gramatica import Gramatica
from Reconhecedor import Reconhecedor

class AnalisadorSintatico:
    def __init__ (self):
        self.reconhecedor = Reconhecedor('in.txt')
        self.gramatica = Gramatica()
        self.test = ''
        path = []

        ans = self.startRun(self.gramatica.gram['P'], path)
        print('reconhecido: {}'.format(ans))

        if ans:
            print("Caminho: {}".format(path))
        # print(self.test)
        # print(self.reconhecedor.tokens)
    
    def startRun(self, rule, path):
        res = self.run(rule, path)
        return res and not self.reconhecedor.tokens

    def run(self, rule, path):

        popped = []
        tokens = self.reconhecedor.tokens
        path.append(rule)
        

        accepted = True
        for production in rule:
            # print(self.reconhecedor.tokens)
            accepted = True
            for symbol in range(len(production)):
                # print("[{}] = '{}'".format(symbol, production[symbol]))
                if tokens != []:
                    tokenPosition, tokenId = tokens[0]
                    tokenLine, tokenColumn = tokenPosition
                    tokenName = tokenId[1:-1]
                    if tokenName == ',':
                        token = ','
                    else:
                        tokenList = tokenName.split(',')
                        token = tokenList[0]
                else:
                    token = 'null'

                if self.isTerminal(production[symbol]):
                    if production[symbol] != 'eps' and production[symbol] != token:
                        accepted = False
                        break
                    elif production[symbol] != 'eps':
                        pop = self.reconhecedor.tokens.pop(0)
                        self.test += str(pop)
                        popped.append(pop)
                    
                else: # NÃ£o terminal
                    if ['eps'] in self.gramatica.gram[production[symbol]] or self.tokenInFirst(token,production[symbol]):
                        if(not self.run(self.gramatica.gram[production[symbol]], path)):
                            accepted = False
                            break
                    else:
                        accepted = False
                        break
            
            if accepted:
                break
        
        if not accepted:
            self.reconhecedor.tokens = popped + self.reconhecedor.tokens
            path.pop()

        return accepted

    def isTerminal(self, symbol):
        return symbol not in self.gramatica.gram

    def tokenInFirst(self, token, production):
        return production in self.gramatica.firsts[token]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                